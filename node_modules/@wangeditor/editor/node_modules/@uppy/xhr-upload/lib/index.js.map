{"version":3,"sources":["index.js"],"names":["BasePlugin","require","nanoid","Provider","RequestClient","Socket","emitSocketProgress","getSocketHost","settle","EventTracker","ProgressTimeout","RateLimitedQueue","internalRateLimitedQueue","NetworkError","isNetworkError","locale","buildResponseError","xhr","err","error","Error","Object","assign","data","request","setTypeInBlob","file","dataWithUpdatedType","slice","size","meta","type","module","exports","XHRUpload","constructor","uppy","opts","id","title","defaultLocale","defaultOptions","formData","fieldName","bundle","method","metaFields","responseUrlFieldName","headers","timeout","limit","withCredentials","responseType","getResponseData","responseText","parsedResponse","JSON","parse","log","getResponseError","_","response","validateStatus","status","i18nInit","handleUpload","bind","requests","uploaderEvents","create","getOptions","overrides","getState","xhrUpload","addMetadata","Array","isArray","keys","forEach","item","append","createFormDataUpload","formPost","FormData","name","createBundledUpload","files","options","upload","current","total","Promise","resolve","reject","emit","XMLHttpRequest","timer","abort","queuedRequest","done","i18n","seconds","Math","ceil","addEventListener","ev","loaded","progress","lengthComputable","uploader","bytesUploaded","bytesTotal","remove","target","body","uploadURL","uploadResp","open","toUpperCase","endpoint","run","currentOpts","header","setRequestHeader","send","onFileRemove","onCancelAll","uploadRemote","fields","Client","remote","providerOptions","provider","client","post","url","fieldname","metadata","httpMethod","useFormData","then","res","token","host","companionUrl","socket","autoOpen","onRetry","onRetryAll","on","progressData","errData","resp","message","cause","isPaused","close","catch","uploadBundle","optsFromState","emitError","uploadFiles","promises","map","i","parseInt","length","isRemote","fileID","cb","targetFileID","getFile","fileIDs","isSomeFileRemote","some","TypeError","install","capabilities","setState","individualCancellation","addUploader","uninstall","removeUploader","VERSION"],"mappings":"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","sourcesContent":["const BasePlugin = require('@uppy/core/lib/BasePlugin')\nconst { nanoid } = require('nanoid/non-secure')\nconst { Provider, RequestClient, Socket } = require('@uppy/companion-client')\nconst emitSocketProgress = require('@uppy/utils/lib/emitSocketProgress')\nconst getSocketHost = require('@uppy/utils/lib/getSocketHost')\nconst settle = require('@uppy/utils/lib/settle')\nconst EventTracker = require('@uppy/utils/lib/EventTracker')\nconst ProgressTimeout = require('@uppy/utils/lib/ProgressTimeout')\nconst { RateLimitedQueue, internalRateLimitedQueue } = require('@uppy/utils/lib/RateLimitedQueue')\nconst NetworkError = require('@uppy/utils/lib/NetworkError')\nconst isNetworkError = require('@uppy/utils/lib/isNetworkError')\n\nconst locale = require('./locale')\n\nfunction buildResponseError (xhr, err) {\n  let error = err\n  // No error message\n  if (!error) error = new Error('Upload error')\n  // Got an error message string\n  if (typeof error === 'string') error = new Error(error)\n  // Got something else\n  if (!(error instanceof Error)) {\n    error = Object.assign(new Error('Upload error'), { data: error })\n  }\n\n  if (isNetworkError(xhr)) {\n    error = new NetworkError(error, xhr)\n    return error\n  }\n\n  error.request = xhr\n  return error\n}\n\n/**\n * Set `data.type` in the blob to `file.meta.type`,\n * because we might have detected a more accurate file type in Uppy\n * https://stackoverflow.com/a/50875615\n *\n * @param {object} file File object with `data`, `size` and `meta` properties\n * @returns {object} blob updated with the new `type` set from `file.meta.type`\n */\nfunction setTypeInBlob (file) {\n  const dataWithUpdatedType = file.data.slice(0, file.data.size, file.meta.type)\n  return dataWithUpdatedType\n}\n\nmodule.exports = class XHRUpload extends BasePlugin {\n  // eslint-disable-next-line global-require\n  static VERSION = require('../package.json').version\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = this.opts.id || 'XHRUpload'\n    this.title = 'XHRUpload'\n\n    this.defaultLocale = locale\n\n    // Default options\n    const defaultOptions = {\n      formData: true,\n      fieldName: opts.bundle ? 'files[]' : 'file',\n      method: 'post',\n      metaFields: null,\n      responseUrlFieldName: 'url',\n      bundle: false,\n      headers: {},\n      timeout: 30 * 1000,\n      limit: 5,\n      withCredentials: false,\n      responseType: '',\n      /**\n       * @typedef respObj\n       * @property {string} responseText\n       * @property {number} status\n       * @property {string} statusText\n       * @property {object.<string, string>} headers\n       *\n       * @param {string} responseText the response body string\n       * @param {XMLHttpRequest | respObj} response the response object (XHR or similar)\n       */\n      getResponseData (responseText) {\n        let parsedResponse = {}\n        try {\n          parsedResponse = JSON.parse(responseText)\n        } catch (err) {\n          uppy.log(err)\n        }\n\n        return parsedResponse\n      },\n      /**\n       *\n       * @param {string} responseText the response body string\n       * @param {XMLHttpRequest | respObj} response the response object (XHR or similar)\n       */\n      getResponseError (_, response) {\n        let error = new Error('Upload error')\n\n        if (isNetworkError(response)) {\n          error = new NetworkError(error, response)\n        }\n\n        return error\n      },\n      /**\n       * Check if the response from the upload endpoint indicates that the upload was successful.\n       *\n       * @param {number} status the response status code\n       */\n      validateStatus (status) {\n        return status >= 200 && status < 300\n      },\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n    this.i18nInit()\n\n    this.handleUpload = this.handleUpload.bind(this)\n\n    // Simultaneous upload limiting is shared across all uploads with this plugin.\n    if (internalRateLimitedQueue in this.opts) {\n      this.requests = this.opts[internalRateLimitedQueue]\n    } else {\n      this.requests = new RateLimitedQueue(this.opts.limit)\n    }\n\n    if (this.opts.bundle && !this.opts.formData) {\n      throw new Error('`opts.formData` must be true when `opts.bundle` is enabled.')\n    }\n\n    this.uploaderEvents = Object.create(null)\n  }\n\n  getOptions (file) {\n    const overrides = this.uppy.getState().xhrUpload\n    const { headers } = this.opts\n\n    const opts = {\n      ...this.opts,\n      ...(overrides || {}),\n      ...(file.xhrUpload || {}),\n      headers: {},\n    }\n    // Support for `headers` as a function, only in the XHRUpload settings.\n    // Options set by other plugins in Uppy state or on the files themselves are still merged in afterward.\n    //\n    // ```js\n    // headers: (file) => ({ expires: file.meta.expires })\n    // ```\n    if (typeof headers === 'function') {\n      opts.headers = headers(file)\n    } else {\n      Object.assign(opts.headers, this.opts.headers)\n    }\n\n    if (overrides) {\n      Object.assign(opts.headers, overrides.headers)\n    }\n    if (file.xhrUpload) {\n      Object.assign(opts.headers, file.xhrUpload.headers)\n    }\n\n    return opts\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  addMetadata (formData, meta, opts) {\n    const metaFields = Array.isArray(opts.metaFields)\n      ? opts.metaFields\n      : Object.keys(meta) // Send along all fields by default.\n\n    metaFields.forEach((item) => {\n      formData.append(item, meta[item])\n    })\n  }\n\n  createFormDataUpload (file, opts) {\n    const formPost = new FormData()\n\n    this.addMetadata(formPost, file.meta, opts)\n\n    const dataWithUpdatedType = setTypeInBlob(file)\n\n    if (file.name) {\n      formPost.append(opts.fieldName, dataWithUpdatedType, file.meta.name)\n    } else {\n      formPost.append(opts.fieldName, dataWithUpdatedType)\n    }\n\n    return formPost\n  }\n\n  createBundledUpload (files, opts) {\n    const formPost = new FormData()\n\n    const { meta } = this.uppy.getState()\n    this.addMetadata(formPost, meta, opts)\n\n    files.forEach((file) => {\n      const options = this.getOptions(file)\n\n      const dataWithUpdatedType = setTypeInBlob(file)\n\n      if (file.name) {\n        formPost.append(options.fieldName, dataWithUpdatedType, file.name)\n      } else {\n        formPost.append(options.fieldName, dataWithUpdatedType)\n      }\n    })\n\n    return formPost\n  }\n\n  upload (file, current, total) {\n    const opts = this.getOptions(file)\n\n    this.uppy.log(`uploading ${current} of ${total}`)\n    return new Promise((resolve, reject) => {\n      this.uppy.emit('upload-started', file)\n\n      const data = opts.formData\n        ? this.createFormDataUpload(file, opts)\n        : file.data\n\n      const xhr = new XMLHttpRequest()\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      const timer = new ProgressTimeout(opts.timeout, () => {\n        xhr.abort()\n        queuedRequest.done()\n        const error = new Error(this.i18n('timedOut', { seconds: Math.ceil(opts.timeout / 1000) }))\n        this.uppy.emit('upload-error', file, error)\n        reject(error)\n      })\n\n      const id = nanoid()\n\n      xhr.upload.addEventListener('loadstart', () => {\n        this.uppy.log(`[XHRUpload] ${id} started`)\n      })\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} progress: ${ev.loaded} / ${ev.total}`)\n        // Begin checking for timeouts when progress starts, instead of loading,\n        // to avoid timing out requests on browser concurrency queue\n        timer.progress()\n\n        if (ev.lengthComputable) {\n          this.uppy.emit('upload-progress', file, {\n            uploader: this,\n            bytesUploaded: ev.loaded,\n            bytesTotal: ev.total,\n          })\n        }\n      })\n\n      xhr.addEventListener('load', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} finished`)\n        timer.done()\n        queuedRequest.done()\n        if (this.uploaderEvents[file.id]) {\n          this.uploaderEvents[file.id].remove()\n          this.uploaderEvents[file.id] = null\n        }\n\n        if (opts.validateStatus(ev.target.status, xhr.responseText, xhr)) {\n          const body = opts.getResponseData(xhr.responseText, xhr)\n          const uploadURL = body[opts.responseUrlFieldName]\n\n          const uploadResp = {\n            status: ev.target.status,\n            body,\n            uploadURL,\n          }\n\n          this.uppy.emit('upload-success', file, uploadResp)\n\n          if (uploadURL) {\n            this.uppy.log(`Download ${file.name} from ${uploadURL}`)\n          }\n\n          return resolve(file)\n        }\n        const body = opts.getResponseData(xhr.responseText, xhr)\n        const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n\n        const response = {\n          status: ev.target.status,\n          body,\n        }\n\n        this.uppy.emit('upload-error', file, error, response)\n        return reject(error)\n      })\n\n      xhr.addEventListener('error', () => {\n        this.uppy.log(`[XHRUpload] ${id} errored`)\n        timer.done()\n        queuedRequest.done()\n        if (this.uploaderEvents[file.id]) {\n          this.uploaderEvents[file.id].remove()\n          this.uploaderEvents[file.id] = null\n        }\n\n        const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n        this.uppy.emit('upload-error', file, error)\n        return reject(error)\n      })\n\n      xhr.open(opts.method.toUpperCase(), opts.endpoint, true)\n      // IE10 does not allow setting `withCredentials` and `responseType`\n      // before `open()` is called.\n      xhr.withCredentials = opts.withCredentials\n      if (opts.responseType !== '') {\n        xhr.responseType = opts.responseType\n      }\n\n      const queuedRequest = this.requests.run(() => {\n        this.uppy.emit('upload-started', file)\n\n        // When using an authentication system like JWT, the bearer token goes as a header. This\n        // header needs to be fresh each time the token is refreshed so computing and setting the\n        // headers just before the upload starts enables this kind of authentication to work properly.\n        // Otherwise, half-way through the list of uploads the token could be stale and the upload would fail.\n        const currentOpts = this.getOptions(file)\n\n        Object.keys(currentOpts.headers).forEach((header) => {\n          xhr.setRequestHeader(header, currentOpts.headers[header])\n        })\n\n        xhr.send(data)\n\n        return () => {\n          timer.done()\n          xhr.abort()\n        }\n      })\n\n      this.onFileRemove(file.id, () => {\n        queuedRequest.abort()\n        reject(new Error('File removed'))\n      })\n\n      this.onCancelAll(file.id, () => {\n        queuedRequest.abort()\n        reject(new Error('Upload cancelled'))\n      })\n    })\n  }\n\n  uploadRemote (file) {\n    const opts = this.getOptions(file)\n    return new Promise((resolve, reject) => {\n      this.uppy.emit('upload-started', file)\n\n      const fields = {}\n      const metaFields = Array.isArray(opts.metaFields)\n        ? opts.metaFields\n        // Send along all fields by default.\n        : Object.keys(file.meta)\n\n      metaFields.forEach((name) => {\n        fields[name] = file.meta[name]\n      })\n\n      const Client = file.remote.providerOptions.provider ? Provider : RequestClient\n      const client = new Client(this.uppy, file.remote.providerOptions)\n      client.post(file.remote.url, {\n        ...file.remote.body,\n        endpoint: opts.endpoint,\n        size: file.data.size,\n        fieldname: opts.fieldName,\n        metadata: fields,\n        httpMethod: opts.method,\n        useFormData: opts.formData,\n        headers: opts.headers,\n      }).then((res) => {\n        const { token } = res\n        const host = getSocketHost(file.remote.companionUrl)\n        const socket = new Socket({ target: `${host}/api/${token}`, autoOpen: false })\n        this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n        this.onFileRemove(file.id, () => {\n          socket.send('cancel', {})\n          queuedRequest.abort()\n          resolve(`upload ${file.id} was removed`)\n        })\n\n        this.onCancelAll(file.id, () => {\n          socket.send('cancel', {})\n          queuedRequest.abort()\n          resolve(`upload ${file.id} was canceled`)\n        })\n\n        this.onRetry(file.id, () => {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        })\n\n        this.onRetryAll(file.id, () => {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        })\n\n        socket.on('progress', (progressData) => emitSocketProgress(this, progressData, file))\n\n        socket.on('success', (data) => {\n          const body = opts.getResponseData(data.response.responseText, data.response)\n          const uploadURL = body[opts.responseUrlFieldName]\n\n          const uploadResp = {\n            status: data.response.status,\n            body,\n            uploadURL,\n          }\n\n          this.uppy.emit('upload-success', file, uploadResp)\n          queuedRequest.done()\n          if (this.uploaderEvents[file.id]) {\n            this.uploaderEvents[file.id].remove()\n            this.uploaderEvents[file.id] = null\n          }\n          return resolve()\n        })\n\n        socket.on('error', (errData) => {\n          const resp = errData.response\n          const error = resp\n            ? opts.getResponseError(resp.responseText, resp)\n            : Object.assign(new Error(errData.error.message), { cause: errData.error })\n          this.uppy.emit('upload-error', file, error)\n          queuedRequest.done()\n          if (this.uploaderEvents[file.id]) {\n            this.uploaderEvents[file.id].remove()\n            this.uploaderEvents[file.id] = null\n          }\n          reject(error)\n        })\n\n        const queuedRequest = this.requests.run(() => {\n          socket.open()\n          if (file.isPaused) {\n            socket.send('pause', {})\n          }\n\n          return () => socket.close()\n        })\n      }).catch((err) => {\n        this.uppy.emit('upload-error', file, err)\n        reject(err)\n      })\n    })\n  }\n\n  uploadBundle (files) {\n    return new Promise((resolve, reject) => {\n      const { endpoint } = this.opts\n      const { method } = this.opts\n\n      const optsFromState = this.uppy.getState().xhrUpload\n      const formData = this.createBundledUpload(files, {\n        ...this.opts,\n        ...(optsFromState || {}),\n      })\n\n      const xhr = new XMLHttpRequest()\n\n      const timer = new ProgressTimeout(this.opts.timeout, () => {\n        xhr.abort()\n        const error = new Error(this.i18n('timedOut', { seconds: Math.ceil(this.opts.timeout / 1000) }))\n        emitError(error)\n        reject(error)\n      })\n\n      const emitError = (error) => {\n        files.forEach((file) => {\n          this.uppy.emit('upload-error', file, error)\n        })\n      }\n\n      xhr.upload.addEventListener('loadstart', () => {\n        this.uppy.log('[XHRUpload] started uploading bundle')\n        timer.progress()\n      })\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        timer.progress()\n\n        if (!ev.lengthComputable) return\n\n        files.forEach((file) => {\n          this.uppy.emit('upload-progress', file, {\n            uploader: this,\n            bytesUploaded: ev.loaded / ev.total * file.size,\n            bytesTotal: file.size,\n          })\n        })\n      })\n\n      xhr.addEventListener('load', (ev) => {\n        timer.done()\n\n        if (this.opts.validateStatus(ev.target.status, xhr.responseText, xhr)) {\n          const body = this.opts.getResponseData(xhr.responseText, xhr)\n          const uploadResp = {\n            status: ev.target.status,\n            body,\n          }\n          files.forEach((file) => {\n            this.uppy.emit('upload-success', file, uploadResp)\n          })\n          return resolve()\n        }\n\n        const error = this.opts.getResponseError(xhr.responseText, xhr) || new Error('Upload error')\n        error.request = xhr\n        emitError(error)\n        return reject(error)\n      })\n\n      xhr.addEventListener('error', () => {\n        timer.done()\n\n        const error = this.opts.getResponseError(xhr.responseText, xhr) || new Error('Upload error')\n        emitError(error)\n        return reject(error)\n      })\n\n      this.uppy.on('cancel-all', () => {\n        timer.done()\n        xhr.abort()\n      })\n\n      xhr.open(method.toUpperCase(), endpoint, true)\n      // IE10 does not allow setting `withCredentials` and `responseType`\n      // before `open()` is called.\n      xhr.withCredentials = this.opts.withCredentials\n      if (this.opts.responseType !== '') {\n        xhr.responseType = this.opts.responseType\n      }\n\n      Object.keys(this.opts.headers).forEach((header) => {\n        xhr.setRequestHeader(header, this.opts.headers[header])\n      })\n\n      xhr.send(formData)\n\n      files.forEach((file) => {\n        this.uppy.emit('upload-started', file)\n      })\n    })\n  }\n\n  uploadFiles (files) {\n    const promises = files.map((file, i) => {\n      const current = parseInt(i, 10) + 1\n      const total = files.length\n\n      if (file.error) {\n        return Promise.reject(new Error(file.error))\n      } if (file.isRemote) {\n        return this.uploadRemote(file, current, total)\n      }\n      return this.upload(file, current, total)\n    })\n\n    return settle(promises)\n  }\n\n  onFileRemove (fileID, cb) {\n    this.uploaderEvents[fileID].on('file-removed', (file) => {\n      if (fileID === file.id) cb(file.id)\n    })\n  }\n\n  onRetry (fileID, cb) {\n    this.uploaderEvents[fileID].on('upload-retry', (targetFileID) => {\n      if (fileID === targetFileID) {\n        cb()\n      }\n    })\n  }\n\n  onRetryAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('retry-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onCancelAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('cancel-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  handleUpload (fileIDs) {\n    if (fileIDs.length === 0) {\n      this.uppy.log('[XHRUpload] No files to upload!')\n      return Promise.resolve()\n    }\n\n    // No limit configured by the user, and no RateLimitedQueue passed in by a \"parent\" plugin\n    // (basically just AwsS3) using the internal symbol\n    if (this.opts.limit === 0 && !this.opts[internalRateLimitedQueue]) {\n      this.uppy.log(\n        '[XHRUpload] When uploading multiple files at once, consider setting the `limit` option (to `10` for example), to limit the number of concurrent uploads, which helps prevent memory and network issues: https://uppy.io/docs/xhr-upload/#limit-0',\n        'warning',\n      )\n    }\n\n    this.uppy.log('[XHRUpload] Uploading...')\n    const files = fileIDs.map((fileID) => this.uppy.getFile(fileID))\n\n    if (this.opts.bundle) {\n      // if bundle: true, we don’t support remote uploads\n      const isSomeFileRemote = files.some(file => file.isRemote)\n      if (isSomeFileRemote) {\n        throw new Error('Can’t upload remote files when the `bundle: true` option is set')\n      }\n\n      if (typeof this.opts.headers === 'function') {\n        throw new TypeError('`headers` may not be a function when the `bundle: true` option is set')\n      }\n\n      return this.uploadBundle(files)\n    }\n\n    return this.uploadFiles(files).then(() => null)\n  }\n\n  install () {\n    if (this.opts.bundle) {\n      const { capabilities } = this.uppy.getState()\n      this.uppy.setState({\n        capabilities: {\n          ...capabilities,\n          individualCancellation: false,\n        },\n      })\n    }\n\n    this.uppy.addUploader(this.handleUpload)\n  }\n\n  uninstall () {\n    if (this.opts.bundle) {\n      const { capabilities } = this.uppy.getState()\n      this.uppy.setState({\n        capabilities: {\n          ...capabilities,\n          individualCancellation: true,\n        },\n      })\n    }\n\n    this.uppy.removeUploader(this.handleUpload)\n  }\n}\n"]}