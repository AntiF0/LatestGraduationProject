{"version":3,"sources":["RequestClient.js"],"names":["fetchWithNetworkError","require","AuthError","stripSlash","url","replace","handleJSONResponse","res","status","jsonPromise","json","errMsg","statusText","errData","message","requestId","Error","module","exports","RequestClient","constructor","uppy","opts","skip","response","onReceiveResponse","bind","allowedHeaders","preflightDone","hostname","companion","getState","host","companionUrl","headers","userHeaders","companionHeaders","Promise","resolve","defaultHeaders","state","has","get","setState","preflight","path","slice","fetch","method","then","split","map","headerName","trim","toLowerCase","catch","err","log","preflightAndHeaders","all","Object","keys","forEach","header","includes","skipPostResponse","credentials","companionCookiesRule","post","data","body","JSON","stringify","delete","VERSION","Accept","test","isAuthError","error","cause","reject"],"mappings":"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","sourcesContent":["'use strict'\n\nconst fetchWithNetworkError = require('@uppy/utils/lib/fetchWithNetworkError')\nconst AuthError = require('./AuthError')\n\n// Remove the trailing slash so we can always safely append /xyz.\nfunction stripSlash (url) {\n  return url.replace(/\\/$/, '')\n}\n\nasync function handleJSONResponse (res) {\n  if (res.status === 401) {\n    throw new AuthError()\n  }\n\n  const jsonPromise = res.json()\n\n  if (res.status < 200 || res.status > 300) {\n    let errMsg = `Failed request with status: ${res.status}. ${res.statusText}`\n    try {\n      const errData = await jsonPromise\n      errMsg = errData.message ? `${errMsg} message: ${errData.message}` : errMsg\n      errMsg = errData.requestId ? `${errMsg} request-Id: ${errData.requestId}` : errMsg\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      throw new Error(errMsg)\n    }\n  }\n  return jsonPromise\n}\n\nmodule.exports = class RequestClient {\n  // eslint-disable-next-line global-require\n  static VERSION = require('../package.json').version\n\n  #getPostResponseFunc = skip => response => (skip ? response : this.onReceiveResponse(response))\n\n  constructor (uppy, opts) {\n    this.uppy = uppy\n    this.opts = opts\n    this.onReceiveResponse = this.onReceiveResponse.bind(this)\n    this.allowedHeaders = ['accept', 'content-type', 'uppy-auth-token']\n    this.preflightDone = false\n  }\n\n  get hostname () {\n    const { companion } = this.uppy.getState()\n    const host = this.opts.companionUrl\n    return stripSlash(companion && companion[host] ? companion[host] : host)\n  }\n\n  static defaultHeaders = {\n    Accept: 'application/json',\n    'Content-Type': 'application/json',\n    'Uppy-Versions': `@uppy/companion-client=${RequestClient.VERSION}`,\n  }\n\n  headers () {\n    const userHeaders = this.opts.companionHeaders || {}\n    return Promise.resolve({\n      ...RequestClient.defaultHeaders,\n      ...userHeaders,\n    })\n  }\n\n  onReceiveResponse (response) {\n    const state = this.uppy.getState()\n    const companion = state.companion || {}\n    const host = this.opts.companionUrl\n    const { headers } = response\n    // Store the self-identified domain name for the Companion instance we just hit.\n    if (headers.has('i-am') && headers.get('i-am') !== companion[host]) {\n      this.uppy.setState({\n        companion: { ...companion, [host]: headers.get('i-am') },\n      })\n    }\n    return response\n  }\n\n  #getUrl (url) {\n    if (/^(https?:|)\\/\\//.test(url)) {\n      return url\n    }\n    return `${this.hostname}/${url}`\n  }\n\n  #errorHandler (method, path) {\n    return (err) => {\n      if (!err?.isAuthError) {\n        const error = new Error(`Could not ${method} ${this.#getUrl(path)}`)\n        error.cause = err\n        err = error // eslint-disable-line no-param-reassign\n      }\n      return Promise.reject(err)\n    }\n  }\n\n  preflight (path) {\n    if (this.preflightDone) {\n      return Promise.resolve(this.allowedHeaders.slice())\n    }\n\n    return fetch(this.#getUrl(path), {\n      method: 'OPTIONS',\n    })\n      .then((response) => {\n        if (response.headers.has('access-control-allow-headers')) {\n          this.allowedHeaders = response.headers.get('access-control-allow-headers')\n            .split(',').map((headerName) => headerName.trim().toLowerCase())\n        }\n        this.preflightDone = true\n        return this.allowedHeaders.slice()\n      })\n      .catch((err) => {\n        this.uppy.log(`[CompanionClient] unable to make preflight request ${err}`, 'warning')\n        this.preflightDone = true\n        return this.allowedHeaders.slice()\n      })\n  }\n\n  preflightAndHeaders (path) {\n    return Promise.all([this.preflight(path), this.headers()])\n      .then(([allowedHeaders, headers]) => {\n        // filter to keep only allowed Headers\n        Object.keys(headers).forEach((header) => {\n          if (!allowedHeaders.includes(header.toLowerCase())) {\n            this.uppy.log(`[CompanionClient] excluding disallowed header ${header}`)\n            delete headers[header] // eslint-disable-line no-param-reassign\n          }\n        })\n\n        return headers\n      })\n  }\n\n  get (path, skipPostResponse) {\n    const method = 'get'\n    return this.preflightAndHeaders(path)\n      .then((headers) => fetchWithNetworkError(this.#getUrl(path), {\n        method,\n        headers,\n        credentials: this.opts.companionCookiesRule || 'same-origin',\n      }))\n      .then(this.#getPostResponseFunc(skipPostResponse))\n      .then(handleJSONResponse)\n      .catch(this.#errorHandler(method, path))\n  }\n\n  post (path, data, skipPostResponse) {\n    const method = 'post'\n    return this.preflightAndHeaders(path)\n      .then((headers) => fetchWithNetworkError(this.#getUrl(path), {\n        method,\n        headers,\n        credentials: this.opts.companionCookiesRule || 'same-origin',\n        body: JSON.stringify(data),\n      }))\n      .then(this.#getPostResponseFunc(skipPostResponse))\n      .then(handleJSONResponse)\n      .catch(this.#errorHandler(method, path))\n  }\n\n  delete (path, data, skipPostResponse) {\n    const method = 'delete'\n    return this.preflightAndHeaders(path)\n      .then((headers) => fetchWithNetworkError(`${this.hostname}/${path}`, {\n        method,\n        headers,\n        credentials: this.opts.companionCookiesRule || 'same-origin',\n        body: data ? JSON.stringify(data) : null,\n      }))\n      .then(this.#getPostResponseFunc(skipPostResponse))\n      .then(handleJSONResponse)\n      .catch(this.#errorHandler(method, path))\n  }\n}\n"]}